<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Xixi Chatroom</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    #pinned-message {
      background: #fffae6;
      padding: 10px;
      border-bottom: 1px solid #ddd;
      font-weight: bold;
    }

    #messages {
      height: 400px;
      overflow-y: scroll;
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }

    #chat-input {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ddd;
    }

    #chat-input input {
      flex: 1;
      padding: 8px;
    }

    #chat-input button {
      margin-left: 5px;
    }

    #admin-tools {
      padding: 10px;
      background: #f9f9f9;
      border-top: 1px solid #ddd;
      display: none;
    }
  </style>
</head>
<body>
  <!-- Pinned message -->
  <div id="pinned-message"></div>

  <!-- Chat feed -->
  <div id="messages"></div>

  <!-- Input for all users -->
  <div id="chat-input">
    <input type="text" id="message-input" placeholder="Type a message...">
    <button id="send-btn">Send</button>
  </div>

  <!-- Admin-only tools -->
  <div id="admin-tools">
    <input type="url" id="media-url" placeholder="Paste media URL (image/gif/video)">
    <button id="pin-btn">Pin Last Message</button>
  </div>

  <!-- Firebase & Chat JS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, addDoc, query, orderBy, onSnapshot, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAv99TK5HKLHfvt8F1Cql7i22QP-FMqSKU",
      authDomain: "xixichatroom.firebaseapp.com",
      projectId: "xixichatroom",
      storageBucket: "xixichatroom.firebasestorage.app",
      messagingSenderId: "1025842693579",
      appId: "1:1025842693579:web:e553bccf9581e65e55224e",
      measurementId: "G-X3CBKSLFJN"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM
    const sendBtn = document.getElementById("send-btn");
    const msgInput = document.getElementById("message-input");
    const messagesDiv = document.getElementById("messages");
    const pinnedDiv = document.getElementById("pinned-message");
    const adminTools = document.getElementById("admin-tools");
    const mediaInput = document.getElementById("media-url");
    const pinBtn = document.getElementById("pin-btn");

    let currentUser = null;
    let isAdmin = false;

    // ðŸ”‘ Check if user is admin
    async function checkAdmin(uid) {
      const snap = await getDoc(doc(db, "users", uid));
      return snap.exists() && snap.data().admin === true;
    }

    // ðŸ‘¤ Auth: Google popup login
    const provider = new GoogleAuthProvider();
    signInWithPopup(auth, provider).catch(console.error);

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        isAdmin = await checkAdmin(user.uid);
        adminTools.style.display = isAdmin ? "block" : "none";
      }
    });

    // ðŸ’¬ Send text message
    sendBtn.addEventListener("click", async () => {
      if (!msgInput.value.trim()) return;
      await addDoc(collection(db, "rooms", "general", "messages"), {
        text: msgInput.value,
        uid: currentUser.uid,
        createdAt: Date.now()
      });
      msgInput.value = "";
    });

    // ðŸ“Œ Admin-only: Pin last message
    pinBtn.addEventListener("click", async () => {
      if (!isAdmin) return;
      const q = query(collection(db, "rooms", "general", "messages"), orderBy("createdAt", "desc"));
      const snap = await getDocs(q);
      if (!snap.empty) {
        const lastMsg = snap.docs[0];
        await updateDoc(lastMsg.ref, { pinned: true });
      }
    });

    // ðŸ‘€ Realtime listener for messages
    onSnapshot(query(collection(db, "rooms", "general", "messages"), orderBy("createdAt")), (snapshot) => {
      messagesDiv.innerHTML = "";
      snapshot.forEach(docSnap => {
        const msg = docSnap.data();
        const div = document.createElement("div");
        div.textContent = msg.text || "[media]";
        messagesDiv.appendChild(div);

        if (msg.pinned) {
          pinnedDiv.textContent = "ðŸ“Œ " + (msg.text || "[media]");
        }
      });
    });
  </script>
</body>
</html>
